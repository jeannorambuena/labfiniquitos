{# /app/templates/casos/index.html #}
{% extends "base.html" %}

{% block content %}
<div class="container py-4">

  <!-- Encabezado de m√≥dulo con breadcrumb -->
  <div class="mb-3">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb small mb-2">
        <li class="breadcrumb-item"><a href="{{ url_for('home.index') }}">Inicio</a></li>
        <li class="breadcrumb-item active" aria-current="page">Casos</li>
      </ol>
    </nav>
    <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
      <div>
        <h1 class="h3 mb-1">Casos</h1>
        <p class="text-muted mb-0">Gesti√≥n de despidos, autodespidos y renuncias.</p>
      </div>
      <div class="d-flex gap-2">
        <div class="btn-group" role="group" aria-label="Cambiar vista">
          <button id="btnVistaTarjetas" type="button" class="btn btn-outline-secondary btn-sm" data-view="cards">Vista tarjetas</button>
          <button id="btnVistaTabla"    type="button" class="btn btn-outline-secondary btn-sm" data-view="table">Vista tabla</button>
        </div>
        <a href="{{ url_for('casos.nuevo') }}" class="btn btn-primary">
          <span aria-hidden="true">‚ûï</span> Nuevo caso
        </a>
      </div>
    </div>
  </div>

  <!-- Filtros / B√∫squeda (compactos) -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <form method="GET" action="{{ url_for('casos.index') }}" role="search" aria-label="Filtrar casos">
        <div class="row row-cols-1 row-cols-md-auto g-2 align-items-end">
          <div class="col">
            <label for="q" class="form-label small mb-1">B√∫squeda</label>
            <input id="q" name="q" type="search" class="form-control form-control-sm"
                   placeholder="RUT, trabajador, empleador, ID‚Ä¶"
                   value="{{ request.args.get('q','') }}">
          </div>

          <div class="col">
            <label for="tipo" class="form-label small mb-1">Tipo</label>
            <select id="tipo" name="tipo" class="form-select form-select-sm">
              <option value="">Todos</option>
              <option value="despido"      {{ 'selected' if request.args.get('tipo')=='despido' }}>Despido</option>
              <option value="autodespido"  {{ 'selected' if request.args.get('tipo')=='autodespido' }}>Autodespido</option>
              <option value="renuncia"     {{ 'selected' if request.args.get('tipo')=='renuncia' }}>Renuncia</option>
            </select>
          </div>

          <div class="col">
            <label for="estado" class="form-label small mb-1">Estado</label>
            <select id="estado" name="estado" class="form-select form-select-sm">
              <option value="">Todos</option>
              <option value="borrador"     {{ 'selected' if request.args.get('estado')=='borrador' }}>Borrador</option>
              <option value="en_revision"  {{ 'selected' if request.args.get('estado')=='en_revision' }}>En revisi√≥n</option>
              <option value="completo"     {{ 'selected' if request.args.get('estado')=='completo' }}>Completo</option>
            </select>
          </div>

          <div class="col">
            <label for="desde" class="form-label small mb-1">Desde</label>
            <input id="desde" name="desde" type="date" class="form-control form-control-sm"
                   value="{{ request.args.get('desde','') }}">
          </div>

          <div class="col">
            <label for="hasta" class="form-label small mb-1">Hasta</label>
            <input id="hasta" name="hasta" type="date" class="form-control form-control-sm"
                   value="{{ request.args.get('hasta','') }}">
          </div>

          <div class="col ms-md-auto d-grid d-md-flex gap-2">
            <a href="{{ url_for('casos.index') }}" class="btn btn-outline-secondary btn-sm">Limpiar</a>
            <button type="submit" class="btn btn-primary btn-sm">
              <span aria-hidden="true">üîç</span> Buscar
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  {# === VISTA TARJETAS (resumen t√©cnico reutilizado) === #}
  <div id="vistaTarjetas" class="d-none">
    {% if casos and casos|length %}
      <div class="d-grid gap-3">
        {% for c in casos %}
          {# Reutiliza la tarjeta de resumen t√©cnico por caso #}
          {% set caso = c %}
          {% include 'casos/_resumen_tecnico.html' %}
        {% endfor %}
      </div>
    {% else %}
      <div class="card border-0 shadow-sm">
        <div class="card-body text-center py-5">
          <div class="mb-2">A√∫n no hay casos registrados.</div>
          <a class="btn btn-primary" href="{{ url_for('casos.nuevo') }}">Crear el primer caso</a>
        </div>
      </div>
    {% endif %}
  </div>

  {# === VISTA TABLA (tu vista original, intacta) === #}
  <div id="vistaTabla">
    <div class="card shadow-sm">
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th scope="col">ID</th>
              <th scope="col">Trabajador</th>
              <th scope="col">Empleador</th>
              <th scope="col">Tipo</th>
              <th scope="col">Estado</th>
              <th scope="col">Actualizado</th>
              <th scope="col" class="text-end">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% if casos and casos|length %}
              {% for c in casos %}
              <tr>
                <td>
                  <a href="{{ url_for('casos.detalle', id=c.id) }}" class="text-decoration-none fw-semibold">#{{ c.id }}</a>
                  <div class="text-muted small">{{ c.codigo_humano if c.codigo_humano else '' }}</div>
                </td>
                <td>
                  <div class="fw-semibold">{{ c.trabajador_nombre }}</div>
                  <div class="text-muted small">{{ c.trabajador_rut }}</div>
                </td>
                <td>
                  <div class="fw-semibold">{{ c.empleador_razon_social }}</div>
                  <div class="text-muted small">{{ c.empleador_rut }}</div>
                </td>
                <td class="text-capitalize">{{ c.tipo or c.tipo_caso or '‚Äî' }}</td>
                <td>
                  {% set estado = (c.estado or 'borrador') %}
                  {% if estado == 'completo' %}
                    <span class="badge bg-success-subtle text-success border border-success-subtle">Completo</span>
                  {% elif estado == 'en_revision' %}
                    <span class="badge bg-warning-subtle text-warning border border-warning-subtle">En revisi√≥n</span>
                  {% elif estado == 'borrador' %}
                    <span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle">Borrador</span>
                  {% else %}
                    <span class="badge text-bg-info">{{ estado }}</span>
                  {% endif %}
                </td>
                <td>
                  <time datetime="{{ (c.fecha_creacion_fmt or c.actualizado_en)|default('', true) }}">
                    {{ c.fecha_creacion_fmt or c.actualizado_en or '‚Äî' }}
                  </time>
                </td>
                <td class="text-end">
                  <div class="btn-group" role="group" aria-label="Acciones del caso {{ c.id }}">
                    <a href="{{ url_for('casos.detalle', id=c.id) }}" class="btn btn-sm btn-outline-primary">Abrir</a>
                    <a href="{{ url_for('casos.editar', id=c.id) }}" class="btn btn-sm btn-outline-secondary">Editar</a>
                    <a href="{{ url_for('casos.generar', id=c.id) }}" class="btn btn-sm btn-outline-success">Generar</a>
                  </div>
                </td>
              </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="7" class="text-center py-5">
                  <div class="text-muted">No hay casos para los filtros aplicados.</div>
                  <div class="mt-3">
                    <a href="{{ url_for('casos.nuevo') }}" class="btn btn-primary">
                      <span aria-hidden="true">‚ûï</span> Crear el primer caso
                    </a>
                  </div>
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>

      {% if pagination %}
      <div class="card-footer d-flex justify-content-between align-items-center">
        <div class="text-muted small">
          Mostrando {{ pagination.start_index }}‚Äì{{ pagination.end_index }} de {{ pagination.total }} resultados
        </div>
        <nav aria-label="Paginaci√≥n de casos">
          <ul class="pagination mb-0">
            <li class="page-item {{ 'disabled' if not pagination.prev }}"><a class="page-link" href="{{ pagination.prev or '#' }}">Anterior</a></li>
            {% for p in pagination.pages %}
              <li class="page-item {{ 'active' if p.active }}"><a class="page-link" href="{{ p.url }}">{{ p.label }}</a></li>
            {% endfor %}
            <li class="page-item {{ 'disabled' if not pagination.next }}"><a class="page-link" href="{{ pagination.next or '#' }}">Siguiente</a></li>
          </ul>
        </nav>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Toggle de vista persistente -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const k = 'casos.view';
  const btnCards = document.getElementById('btnVistaTarjetas');
  const btnTable = document.getElementById('btnVistaTabla');
  const vCards = document.getElementById('vistaTarjetas');
  const vTable = document.getElementById('vistaTabla');

  function setActive(view){
    localStorage.setItem(k, view);
    const cards = (view === 'cards');
    vCards.classList.toggle('d-none', !cards);
    vTable.classList.toggle('d-none', cards);
    btnCards.classList.toggle('btn-secondary', cards);
    btnCards.classList.toggle('btn-outline-secondary', !cards);
    btnTable.classList.toggle('btn-secondary', !cards);
    btnTable.classList.toggle('btn-outline-secondary', cards);
  }

  btnCards.addEventListener('click', () => setActive('cards'));
  btnTable.addEventListener('click', () => setActive('table'));

  setActive(localStorage.getItem(k) || 'table');
});
</script>
{% endblock %}
