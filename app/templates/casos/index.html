{# /app/templates/casos/index.html #}
{% extends "base.html" %}

{% block content %}
<div class="container py-4">

  <!-- Encabezado de m√≥dulo -->
  <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3 mb-3">
    <div>
      <h1 class="h3 mb-1">Casos</h1>
      <p class="text-muted mb-0">Gesti√≥n de despidos, autodespidos y renuncias.</p>
    </div>
    <div class="d-flex gap-2">
      <a href="{{ url_for('casos.nuevo') }}" class="btn btn-primary">
        <span aria-hidden="true">‚ûï</span> Nuevo caso
      </a>
    </div>
  </div>

  <!-- Filtros / B√∫squeda -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <form method="GET" action="{{ url_for('casos.index') }}" class="row g-3" role="search" aria-label="Filtrar casos">
        <div class="col-12 col-md-4">
          <label for="q" class="form-label">B√∫squeda</label>
          <input id="q" name="q" type="search" class="form-control" placeholder="RUT, nombre trabajador, empleador, ID de caso..." value="{{ request.args.get('q','') }}">
        </div>

        <div class="col-6 col-md-3">
          <label for="tipo" class="form-label">Tipo</label>
          <select id="tipo" name="tipo" class="form-select">
            <option value="">Todos</option>
            <option value="despido"      {{ 'selected' if request.args.get('tipo')=='despido' }}>Despido</option>
            <option value="autodespido"  {{ 'selected' if request.args.get('tipo')=='autodespido' }}>Autodespido</option>
            <option value="renuncia"     {{ 'selected' if request.args.get('tipo')=='renuncia' }}>Renuncia</option>
          </select>
        </div>

        <div class="col-6 col-md-3">
          <label for="estado" class="form-label">Estado</label>
          <select id="estado" name="estado" class="form-select">
            <option value="">Todos</option>
            <option value="borrador"     {{ 'selected' if request.args.get('estado')=='borrador' }}>Borrador</option>
            <option value="en_revision"  {{ 'selected' if request.args.get('estado')=='en_revision' }}>En revisi√≥n</option>
            <option value="completo"     {{ 'selected' if request.args.get('estado')=='completo' }}>Completo</option>
          </select>
        </div>

        <div class="col-6 col-md-2">
          <label for="desde" class="form-label">Desde</label>
          <input id="desde" name="desde" type="date" class="form-control" value="{{ request.args.get('desde','') }}">
        </div>

        <div class="col-6 col-md-2">
          <label for="hasta" class="form-label">Hasta</label>
          <input id="hasta" name="hasta" type="date" class="form-control" value="{{ request.args.get('hasta','') }}">
        </div>

        <div class="col-12 d-flex gap-2 justify-content-end">
          <a href="{{ url_for('casos.index') }}" class="btn btn-outline-secondary">Limpiar</a>
          <button type="submit" class="btn btn-primary">
            <span aria-hidden="true">üîç</span> Buscar
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Tabla responsiva -->
  <div class="card shadow-sm">
    <div class="table-responsive">
      <table class="table align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th scope="col">ID</th>
            <th scope="col">Trabajador</th>
            <th scope="col">Empleador</th>
            <th scope="col">Tipo</th>
            <th scope="col">Estado</th>
            <th scope="col">Actualizado</th>
            <th scope="col" class="text-end">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% if casos and casos|length %}
            {% for c in casos %}
            <tr>
              <td><a href="{{ url_for('casos.detalle', id=c.id) }}" class="text-decoration-none fw-semibold">#{{ c.id }}</a></td>
              <td>
                <div class="fw-semibold">{{ c.trabajador_nombre }}</div>
                <div class="text-muted small">{{ c.trabajador_rut }}</div>
              </td>
              <td>
                <div class="fw-semibold">{{ c.empleador_razon_social }}</div>
                <div class="text-muted small">{{ c.empleador_rut }}</div>
              </td>
              <td class="text-capitalize">{{ c.tipo_caso or '‚Äî' }}</td>
              <td>
                {% set estado = c.estado or 'borrador' %}
                {% if estado == 'completo' %}
                  <span class="badge bg-success-subtle text-success border border-success-subtle">Completo</span>
                {% elif estado == 'en_revision' %}
                  <span class="badge bg-warning-subtle text-warning border border-warning-subtle">En revisi√≥n</span>
                {% else %}
                  <span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle">Borrador</span>
                {% endif %}
              </td>
              <td>
                <time datetime="{{ c.actualizado_en|default('', true) }}">
                  {{ c.actualizado_en|default('‚Äî') }}
                </time>
              </td>
              <td class="text-end">
                <div class="btn-group" role="group" aria-label="Acciones del caso {{ c.id }}">
                  <a href="{{ url_for('casos.detalle', id=c.id) }}" class="btn btn-sm btn-outline-primary">Abrir</a>
                  <a href="{{ url_for('casos.editar', id=c.id) }}" class="btn btn-sm btn-outline-secondary">Editar</a>
                  <a href="{{ url_for('casos.generar', id=c.id) }}" class="btn btn-sm btn-outline-success">Generar</a>
                </div>
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="7" class="text-center py-5">
                <div class="text-muted">No hay casos para los filtros aplicados.</div>
                <div class="mt-3">
                  <a href="{{ url_for('casos.nuevo') }}" class="btn btn-primary">
                    <span aria-hidden="true">‚ûï</span> Crear el primer caso
                  </a>
                </div>
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
    {% if pagination %}
    <div class="card-footer d-flex justify-content-between align-items-center">
      <div class="text-muted small">
        Mostrando {{ pagination.start_index }}‚Äì{{ pagination.end_index }} de {{ pagination.total }} resultados
      </div>
      <nav aria-label="Paginaci√≥n de casos">
        <ul class="pagination mb-0">
          <li class="page-item {{ 'disabled' if not pagination.prev }}"><a class="page-link" href="{{ pagination.prev or '#' }}">Anterior</a></li>
          {% for p in pagination.pages %}
            <li class="page-item {{ 'active' if p.active }}"><a class="page-link" href="{{ p.url }}">{{ p.label }}</a></li>
          {% endfor %}
          <li class="page-item {{ 'disabled' if not pagination.next }}"><a class="page-link" href="{{ pagination.next or '#' }}">Siguiente</a></li>
        </ul>
      </nav>
    </div>
    {% endif %}
  </div>

</div>
{% endblock %}
